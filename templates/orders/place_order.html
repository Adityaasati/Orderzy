{% extends 'base.html' %} {% load custom_filters %} {% block content %}

<div class="main-section pt-5">
  <div class="page-section">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
          <div class="tabs-holder horizontal">
            <ul class="stickynav-tabs nav nav-tabs">
              <li class="active">
                <a data-toggle="tab" href="#home"
                  ><i class="fa fa-shopping-cart text-danger"></i>Review Your
                  Billing Address</a
                >
              </li>
            </ul>
            <div class="tab-content">
              <div id="home" class="tab-pane in active">
                <div class="menu-itam-holder">
                  {% if restaurant_ids|length == 1 and order.pre_order_time == 0%}
                  <p
                    style="
                      font-style: italic !important;
                      color: #F28500  !important;
                    "
                    
                  >
                    You are <strong>{{ away_restaurant_order }}</strong>
                    <sup>{{ away_restaurant_order|ordinal }}</sup> in a queue.
                  </p>
                  {% endif %}

                  <div id="menu-item-list-6272" class="menu-itam-list">
                    <div class="billing-address">
                      <div><b>{{ order.name }}</b></div>
                      <div><b>Phone: </b>{{ order.phone }}</div>
                      {% if order.email %}
                      <div><b>Email: </b>{{ order.email }}</div>
                      {% endif %} {% if order.num_of_people %}
                      <div>
                        <b>Number of People: </b>{{ order.num_of_people }}
                      </div>
                      {% endif %}

                      <div><b>Payment: </b>{{ order.payment_method }}</div>
                      <br />
                      <div>
                        <a
                          href="{% url 'checkout' %}"
                          class="btn btn-outline-danger"
                          >Edit</a
                        >
                      </div>
                      <br />
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
          <div class="tabs-holder horizontal">
            <ul class="stickynav-tabs nav nav-tabs">
              <li class="active">
                <a data-toggle="tab" href="#home"
                  ><i class="icon- icon-room_service"></i>Your Order</a
                >
              </li>
            </ul>
            <div class="tab-content">
              <div id="home" class="tab-pane in active">
                <div class="menu-itam-holder">
                  <div>
                    <table class="table">
                      <tbody>
                        {% for cart_item in cart_items_with_totals %}
                        <tr>
                          <td>
                            <img
                              src="{{cart_item.item.fooditem.image.url}}"
                              width="40"
                              alt="Food Image"
                            />
                          </td>
                          <td>
                            <b>{{cart_item.item.fooditem}}</b>
                          </td>
                          <td>{{cart_item.item.quantity}}</td>
                          <td>{{cart_item.total_price}}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                    <ul>
                      <li style="list-style-type: none">
                        Subtotal
                        <span class="price float-right">
                          <span class="currency">₹</span>
                          <span id="subtotal">{{subtotal}}</span>
                        </span>
                      </li>
                      {%for key, value in service_charge_dict.items %} {% for i,j in value.items %}
                      <li style="list-style-type: none">
                        {{key}} <small>({{i}}%)</small>
                        <span class="price float-right">
                          <span class="currency">₹</span>
                          <span id="tax-{{key}}">{{j}}</span>
                        </span>
                      </li>
                      {% endfor%} {% endfor %}

                      <li style="list-style-type: none; font: weight 600px">
                        Total
                        <span class="price float-right">
                          <span class="currency">₹</span>
                          <span id="total">{{grand_total}}</span>
                        </span>
                      </li>
                      {% if order.payment_method == 'Done' %}
                      <a
    href="{% url 'order_complete' %}?order_no={{ order.order_number }}&trans_id=RESTAURANTORDER"
    class="btn btn-success w-100 p-2 mt-3"
  >
    Order Completed
  </a>

{% else %}

                      <div id="paypal-button-container"></div>
                      {% if order.payment_method == 'Paypal' %}
                      <div id="paypal-button-container"></div>
                      {% elif order.payment_method == 'RazorPay' %}

                      <button class="btn btn-danger w-100">
                        Pay with RazorPay
                      </button>
                      {% endif %}
                      {% endif %}
                      <!-- <a
                        href="{% url 'checkout' %}"
                        class="btn btn-danger w-100 p-2 mt-3"
                        >Proceed to Pay!</a
                      > -->
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  var grandTotal = "{{ grand_total }}";
  var url = "{% url 'payments' %}";
  var order_number = "{{order.order_number}}";
  const csrftoken = getCookie("csrftoken");
  var order_complete = "{% url 'order_complete' %}";
  console.log("csrf:", csrftoken);
  paypal
    .Buttons({
      createOrder: function (data, actions) {
        return actions.order.create({
          purchase_units: [
            {
              amount: {
                value: grandTotal,
              },
            },
          ],
        });
      },
      onApprove: function (data, actions) {
        return actions.order.capture().then(function (orderData) {

          var transaction = orderData.purchase_units[0].payments.captures[0];
          var transaction_id = transaction.id;
          var status = orderData.status;
          var payment_method = "PayPal";

          sendTransaction(transaction_id, payment_method, status);

          const element = document.getElementById("paypal-button-container");
          element.innerHTML = "";
          element.innerHTML =
            '<h4 class="text-center"><i class="fa fa-spinner fa-spin"></i> Please wait ... </h4>';

          // Display a success message or perform additional actions
          // Example: alert('Transaction completed by ' + orderData.payer.name.given_name);
        });
      },
    })
    .render("#paypal-button-container");

  function sendTransaction(transaction_id, payment_method, status) {
    $.ajax({
      type: "POST",
      url: url,
      data: {
        order_number: order_number,
        transaction_id: transaction_id,
        payment_method: payment_method,
        status: status,
        csrfmiddlewaretoken: csrftoken,
      },
      success: function (response) {
        console.log("response++", response);
        window.location.href =
          order_complete +
          "?order_no=" +
          response.order_number +
          "&trans_id=" +
          response.transaction_id;
      },
    });
  }
</script>
{% endblock content %}
